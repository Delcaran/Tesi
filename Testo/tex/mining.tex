\chapter{Mining Pools}\label{mining-pools}

\section{Funzionamento generico}

Un utente fondamentale per l'ecosistema bitcoin è il miner, ovvero colui che si occupa di cercare nuovi blocchi in modo da rafforzare la catena. Dato che tale ricerca richiede tempo e soprattutto consumo di corrente elettrica a causa dei complicati calcoli crittografici interessati, ogni scoperta di un nuovo blocco viene premiato con un quantitativo di BTC predefinito.
Il tipo di attività, il nome di questi nodi e la ricompensa in denaro che ne deriva fanno subito venire in mente un'analogia con i minatori d'oro, che impiegano il loro tempo e il loro duro lavoro per estrarre il prezioso metallo.
Mantenendo tale analogia, è evidente come un minatore da solo, pur impegnandosi al massimo delle sue possibilità, non sia in grado di estrarre tanto oro quanto più minatori riuniti in una compagnia mineraria. La controparte Bitcoin delle compagnie minerarie sono le \emph{mining pools}, società private che si prendono il merito del ritrovamento del blocco, ma dividono la ricompensa con quei miners associati che hanno contribuito al ritrovamento.
Per sapere quanto conviene associarsi ad una mining pool piuttosto che ad un'altra è necessario fare alcuni calcoli.

Definiamo quindi i seguenti dati:
\begin{description}
    \item[$B$] Ricompensa derivata dal ritrovamento del blocco. Viene dimezzata quando abbastanza blocchi vengono trovati, in modo da limitare il numero massimo di BTC a 21 milioni. Inizialmente era di 50 BTC a blocco, ma al momento della stesura è di 25 BTC.
    \item[$D$] Difficoltà nel ritrovamento di un blocco, ovvero il numero di bit pari a 0 che devono essere presenti all'inizio dell'hash del blocco perché esso sia considerato valido. Tale valore viene automaticamente aggiustato dalla rete in modo che venga trovato circa un blocco ogni 10 minuti. In pratica tale valore deve essere calcolato in modo che ogni hash abbia una probabilità pari a $\frac{1}{2^{32} D}$\footnote{Il valore reale di probabilità è $\frac{2^{16} - 1}{2^{48} D}$, ma come osservato da Meni Rosenfeld in \cite{pool-analysis}, l'approssimazione proposta risulta sufficientemente accurata ai fini dell'analisi.} di essere un blocco valido.
    \item[$h$] Hashrate di un nodo, ovvero il numero di hash calcolati nell'intervallo di tempo $t$.
\end{description}
Con questi dati presenti, possiamo dire che un singolo miner con hashrate $h$ nell'intervallo di tempo $t$ potrà calcolare un totale di $ht$ hash e quindi una media di $\frac{ht}{2^{32}D}$ blocchi portandolo ad incassare $\frac{htB}{2^{32} D}$ BTC.

Ricercare un blocco in solitario, con hashrate fisso, è un processo di Poisson con intensità $\lambda_r = \frac{h}{2^{32}D}$ (come già accennato in \ref{misurazioni}), per cui il numero di blocchi trovati nel tempo rispetta la distribuzione di Poisson con parametro $\lambda = t\lambda_r = \frac{ht}{2^{32}D}$\footnote{$\lambda_r$ è un parametro di un processo di Poisson detto \emph{intensità} studiato in modo che tale processo rispetti la distribuzione di probabilità di Poisson con parametro $\lambda = \lambda \cdot \tau$, dove $\tau$ è il tempo trascorso dall'inizio dell'osservazione.}.
Tale $\lambda$ risulta essere anche la varianza\footnote{Per un valore casuale, la varianza $\sigma^2$ è una misura della tendenza che ha tale valore di discostarsi dal suo valore atteso. Di quanto si discosta è stabilito dalla deviazione standard $\sigma = \sqrt{\sigma^2}$.} di questa distribuzione. La varianza del pagamento atteso è $\lambda B^2 = \frac{htB^2}{2^{32}D}$ e la relativa deviazione standard, espressa come frazione del pagamento atteso, è $\frac{\sqrt{\lambda B^2}}{\lambda B} = \frac{1}{\sqrt{\lambda}} = \sqrt{\frac{2^{32}D}{ht}}$.

\begin{esempio}
Bob possiede un computer dedicato in grado di calcolare un miliardo di hash al secondo, $h = 1Gh/s = 10^9 h/s$. Utilizzandolo per un giorno intero ($t = 86400s$) a difficoltà $D = 1690906$ con ricompensa $B = 50BTC$, troverà in media $\frac{ht}{2^{32}D} \approx 0.0119$ blocchi ricevendo in pagamento $0.0119B = 0.595$ BTC.
Bob si trova però con una varianza nel pagamento di $0.0119B^2 = 29.75 \text{BTC}^2$, con una deviazione standard di $\sqrt{29.75 \text{BTC}^2} \approx 5.454 \text{BTC}$, ovvero il 917\% del guadagno previsto. In effetti, la probabilità che alla fine della sua giornata di lavoro Bob abbia guadagnato qualcosa è solo del $1 - e^{-\lambda} \approx 1.18\%$, ben poco per ripagarlo dei soldi investiti nel computer dedicato e della corrente elettrica che esso ha consumato in quella giornata.
\end{esempio}

Come si nota, la varianza è un valore molto rilevante: un miner con hardware di tutto rispetto, se lavora da solo, potrebbe dover aspettare anche tre mesi prima di ricevere un qualsiasi pagamento, figurarsi per guadagnare effettivamente qualcosa. Inoltre è da notare come il mining sia un processo completamente casuale e privo di memoria: il fatto che siano passati tre mesi senza nessun risultato non rende più probabile il ritrovamento di un blocco, anzi, dovrà aspettare di media altri tre mesi. Se a questo si aggiunge la certezza che la difficoltà è pensata per aumentare nel tempo e di conseguenza anche la varianza, è evidente come diventare un miner solitario è estremamente infruttuoso. \\\\

Di contro, associarsi ad una mining pool ha notevoli vantaggi. Una pool infatti in media trova $\frac{Ht}{2^{32}D}$ blocchi nel tempo $t$, con una ricompensa media totale di $\frac{HtB}{2^{32}D}$, dove $H$ è l'hashrate totale a disposizione della pool. Un miner associato il cui hashrate è una frazione $h = qH$ dell'hashrate totale. dovrebbe ricevere $q$ volte la ricompensa totale, ovvero $q\frac{HtB}{2^{32}D} = \frac{htB}{2^{32}D}$ che è esattamente quanto si aspetta di ricevere nel caso in cui abbia lavorato da solo. Il vantaggio sta nella varianza estremamente ridotta: la varianza totale è $\frac{HtB^2}{2^{32}D}$, per cui la varianza per il singolo è $q^2 \frac{HtB^2}{2^{32}D} = q\frac{htB^2}{2^{32}D}$ che corrisponde a $q$ volte la varianza di un minatore solitario. Il beneficio per un minatore è quindi direttamente proporzionale alla dimensione della pool a cui si associa e inversamente proporzionale alla potenza di calcolo che mette a disposizione della pool.

Una mining pool di solito viene gestita da un operatore il quale prende una tariffa per i servizi offerti, solitamente una percentuale fissa $f$ sulla ricompensa derivata dal ritrovamento dei blocchi. Quindi per ogni blocco l'operatore si intasca $fB$ BTC distribuendo $(1-f)B$ ai minatori, per cui il ricavo atteso di un singolo minatore risulta $\frac{(1-f)htB}{2^{32}D}$.
Per stabilire quanto si è contribuito al mining della pool, i minatori trovano e inviano delle fette (\emph{shares}), ovvero hash di un blocco che avrebbero rappresentato un blocco vero se la difficoltà fosse stata pari a 1. Ogni hash calcolato ha una probabilità di $\frac{1}{2^32}$ di essere una share e, assumendo che la funzione di hash sia corretta, dato che è impossibile trovare share senza effettuare gli stessi calcoli necessari per trovare un blocco e anche trovare un blocco senza trovare delle share nel tentativo, il numero delle share trovate da un singolo miner è mediamente proporzionale al numero di hash calcolate dallo stesso miner nel tentativo di trovare un blocco per la pool.\\
Dato che una share ha una probabilità $p = \frac{1}{D}$ di essere un blocco valido, se un minatore lavorasse da solo il ritrovamento di una share gli frutterebbe $pB$, ammesso e non concesso che riesca a trovare il relativo blocco per primo. Impegnandosi in una pool impiegherebbe le stesse risorse e riceverebbe la stessa quantità per ogni share inviata\footnote{$(1-f)pB$ tenendo conto della tariffa dell'operatore.} nel caso in cui un membro qualsiasi della pool trovi il blocco, il che è un evento decisamente più probabile di quello in cui lui da solo trovi il blocco.\\

La differenza tra le varie pool sta nel modo in cui la ricompensa viene divisa tra i minatori. Infatti se l'hashrate di un minatore è troppo basso, la sua varianza influenza il numero di shares che è in grado di trovare, per cui non tutti i minatori troveranno la stessa pool adatta alle loro esigenze, a causa dei differenti sistemi di retribuzione che sono implementati sulle diverse pool. Inoltre anche il mining discontinuo influenza la varianza in un modo che a sua volta dipende dal sistema di ricompensa.
In ogni caso tali considerazioni non hanno effetto sulla quantità del pagamento medio, che risulta sempre essere $(1-f)pB$ per ogni share inviata.

\section{Sistemi di retribuzione semplici}

\subsection{Proporzionale}

In questo sistema, i pagamenti sono calcolati in base ad una divisione in \emph{round}, dove un round è il tempo che intercorre tra due ritrovamenti di blocchi da parte della pool. Alla fine di ogni round, quando il blocco viene ritrovato e la pool riceve la relativa ricompensa, l'operatore trattiene la sua parte e distribuisce il resto tra i minatori in proporzione diretta al numero di share da loro sottoposte durante il round. Se un minatore ha inviato $n$ share il numero totale di share ricevute dalla pool è $N$, allora il pagamento di tale minatore per il round è $\frac{n}{N}(1-f)B$.
La varianza per ogni share è approssimativamente $p^2 B^2 \ln{D}$, dato che la varianza per un minatore solitario è $pB^2$ per share, si tratta di un miglioramento di un fattore pari a $\frac{D}{\ln{D}}$. Questo vale unicamente per piccoli miners. Per i miner più importanti la varianza totale non può scendere sotto un valore che è $q$ volta la varianza del singolo minatore, dove $q=\frac{h}{H}$ è la frazione di potere computazionale della rete fornito dal minatore.
Inoltre tali risultati sono validi solo nel caso in cui il numero di minatori sia costante. Dato che un minatore può essere in grado di stabilire quando è conveniente o meno calcolare blocchi in associazione con una mining pool, è frequente il caso di minatori che si collegano fin quando conviene a loro e si scollegano appena il gioco non vale la candela, pratica detta \emph{pool-hopping} e che permette ai minatori che la sfruttano di guadagnare in quantità superiore alla media per ogni share a discapito di quei minatori che invece contribuiscono in modo continuo alla pool che si troveranno a ricavare meno BTC dal loro lavoro.
Nelle pool proporzionali, il pool-hopping funziona particolarmente bene: il pagamento per ogni share, a meno delle tariffe dell'operatore per semplicità, è $\frac{B}{N}$, per cui più lungo risulta essere il round, meno si guadagna per ogni share. È quindi evidente come un minatore possa guadagnare di più se invia le proprie share durante i round più corti e cambia pool durante quelli lunghi.
Ovviamente nessuno può predire il futuro, ma il passato è ben noto: il numero di share che sono già state inviate nel momento in cui si decide se unirsi o meno ad una pool offre una buona stima di quanto possa ancora essere lungo il round. Ad esempio, se sono già state inviate $2D$ shares, allora chiaramente entro la fine del round si avrà $N \geq 2D$ portando il pagamento per ogni share a meno di $\frac{pB}{2}$, una situazione decisamente poco remunerativa.
Se lavorare per tutto il round porta una ricompensa normale e lavorare solo tardi nel round porta una ricompensa minore, allora è ovvio come lavorare all'inizio del round porti una ricompensa superiore alla media. Secondo Rosenfeld, il punto in cui il pagamento atteso è uguale al pagamento medio si ha quando il numero di share già caricate è il 43.5\% della difficoltà: un pool-hopper si sforzerà quindi di collaborare solo prima del raggiungimento di tale valore e per poi abbandonare la pool e magari ritornare in un nuovo round.

Il problema del metodo proporzionale sta nella sua natura deterministica che molto si discosta dalla natura del problema del ritrovamento di un blocco, un processo del tutto casuale. Infatti il numero di share per round segue una distribuzione geometrica (con parametro di successo $p$ e media aritmetica $D$), la quale è priva di memoria: ci saranno una media di $D$ shares in ogni round e se un numero $I$ di tali share è già stato inviato, il numero di share rimanenti non diminuisce, ma segue sempre la stessa distribuzione risultando in mediamente altre $D$ shares da trovare. Ogni nuova share dovrà competere con le $I$ precedenti e con le $D$ future, per cui per migliorare le probabilità di guadagno è importante che l'unico parametro controllabile $I$ sia il più basso possibile, il che equivale a collegarsi ad una pool all'inizio del round.
Una conseguenza del pool-hopping è che i nodi onesti, che rimangono in una pool per tutta la durata del round, possono teoricamente nel caso peggiore guadagnare fino al 43\% in meno rispetto al guadagno atteso, una situazione assolutamente inaccettabile che mette bene in evidenza gli svantaggi di un metodo proporzionale.

\subsection{Pay-Per-Share (PPS)}

In questo sistema l'operatore non è semplicemente un fornitore di servizi, ma si assorbe tutta la varianza che altrimenti dovrebbero affrontare i minatori: quando uno di esse carica una share, l'operatore immediatamente lo paga con $(1-f)pB$ BTC, ovvero con l'intero valore atteso, ma una volta che il blocco viene trovato l'operatore si tiene tutta la ricompensa.
Si tratta quindi di un sistema deterministico in cui il guadagno è noto a priori, portando diversi vantaggi per i minatori:
\begin{itemize}
    \item Nessuna varianza nella ricompensa per singola share. Esiste comunque una varianza nel numero di share trovate, ma è insignificante.
    \item Nessun ritardo nei tempi di pagamento, in quanto non serve aspettare il ritrovamento del blocco.
    \item Facile verificare che il pagamento sia avvenuto e che sia nel giusto ammontare.
    \item Nessuna perdita dovuta a pool-hopping, inefficace con tale sistema.
\end{itemize}
D'alto canto questi vantaggi sono solo per i minatori, per l'operatore il rischio è invece molto elevato. Come per i minatori nel metodo proporzionale, l'operatore può guadagnare molto in caso di round brevi (in quanto riceve l'intero ammontare della ricompensa pagando solo poche shares) mentre per round lunghi può anche risultare in perdita in modo sostanziale. La sua varianza è infatti la stessa di un minatore solitario il cui hashrate è uguale a quello dell'intera pool. Per compensare tale rischio l'operatore solamente richiede tariffe più alte rispetto agli altri sistemi, e questo è il solo svantaggio a carico dei minatori.
A causa dell'elevato rischio, se l'operatore non è oculato nella gestione delle sue finanze la pool può andare in bancarotta. Rosenfeld ha calcolato che per tenere il rischio di bancarotta sotto una certa soglia $\delta$, l'operatore deve mantenere una quantità di BTC di riserva almeno pari a
\[R = \frac{B \ln\frac{1}{\delta} }{2f}\]
Tale valore è solitamente più elevato di quanto un novello operatore si aspetta, per cui è importante che egli sia un oculato gestore delle proprie finanze prima di assumersi la responsabilità di aprire un tale tipo di pool. I minatori d'altronde prima di iscriversi a questo tipo di pool dovrebbero verificare le competenze dell'operatore, in modo da non rischiare di perdere i propri guadagni a causa di una bancarotta improvvisa.

\section{Sistemi di retribuzione a punteggio}

\subsection{Metodo di Slush}

Prende il nome dalla pool in cui fu per la prima volta implementato ed è il primo metodo progettato con l'obiettivo di rendere inefficiente il pool-hopping.
Si basa sempre sul metodo proporzionale, ma invece di basare le retribuzione sulla semplice conta delle shares, attribuisce uno \emph{score} ad ogni share in base al quale verrà distribuito il premio per il ritrovamento del blocco alla fine del round.
Il punteggio è in relazione diretta al tempo trascorso dall'inizio del round, in modo da contrastare l'effetto visto nel metodo proporzionale. La funzione di score è esponenziale: $s=e^{\frac{T}{C}}$ dove $s$ è lo score assegnato per una share caricata all'istante $T$ e $C$ è una costante.
Tale funzione garantisce che ad un certo punto dopo l'inizio del round si raggiunga uno stato stabile in cui non è più rilevante l'istante in cui una share viene condivisa in quanto lo score attribuito risulta essere identico così come di conseguenza la ricompensa.
Il parametro $C$ controlla la velocità con cui si raggiunge tale stato di stabilità o, equivalentemente, la velocità con cui il punteggio decade in relazione alle shares. Se $C$ è basso il decadimento è rapido, ovvero ogni share ha una elevata possibilità di non ricevere nessun pagamento nel caso di lunghi round. Per round brevi invece il pagamento sarà molto elevato perché non sarà condiviso con molte altre share.
Il risultato è che valori bassi di $C$ aumentando notevolmente la varianza dei pagamenti ricevuti, riducendo però la vulnerabilità al pool-hopping.
Nonostante la sua importanza storica, tale metodo ha diversi aspetti negativi:

\begin{itemize}
	\item Il punto di stabilità viene raggiunto solo ad un certo punto nel round, il che vuol dire che si ripresentano gli stessi problemi del metodo proporzionale relativi a quando associarsi alle mining pools. Sebbene l'effetto non sia altrettanto drastico, la conseguenza è un diretto fallimento delle premesse del metodo che non risulta completamente resistente al pool-hopping.
	\item Dato che lo score dipende dal tempo e non dal numero di share, il metodo è soggetto ad hopping dovuto a fluttuazioni nell'hashrate.
	\item Nel calcolo del punteggio non si tiene conto della difficoltà nel trovare un blocco, quindi il metodo può subire hopping derivato dai cambiamenti previsti nella difficoltà.
\end{itemize}

Il primo problema è il più grave in quanto è un caso di un problema più generale: un sistema che ad ogni divide una ricompensa in modo proporzionale tra i minatori partecipanti al round può essere immune al pool-hopping solo se retribuisce la share che ha risolto il round, il che risulta equivalente al mining in solitario e quindi indesiderabile a causa dell'elevata varianza. Tale affermazione è nota come \emph{teorema dell'immunità da hopping}, dimostrato da Rosenfeld nell'appendice D di \cite{pool-analysis}.

\subsection{Metodo Geometrico}

Una evoluzione del motodo di Slush che risulta essere immune da hopping.
In questo metodo esistono due tipi di tariffe, una fissa e una variabile. La tariffa fissa viene scalata dalla ricompensa di ogni blocco, mentre quella variabile è un punteggio assegnato automaticamente all'operatore all'inizio di ogni round e che decade nel tempo esattamente come il punteggio dei minatori.
Questo porta alla creazione di uno stato stabile in cui il punteggio per ogni share rimane costante eliminando le differenze derivanti dai tempi di condivisione delle share. L'algoritmo \ref{alg_metodo_geometrico} illustra il funzionamento del metodo.

\input{./tex/metodogeometrico.tex}
